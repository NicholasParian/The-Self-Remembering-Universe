import numpy as np
from evolve import initialize_wavefunction, recursive_step_dynamic

def run_collapse_trigger_test(
    grid_shape=(20, 20),
    width=[0.01, 0.01],
    sigma=[0.005, 0.005, 0.005, 0.005],
    lambda_E=50.0,
    lambda_crit=0.05,
    epsilon=1e-6,
    n_steps=50
):
    print("üî¨ Running collapse trigger test...")

    psi_n, grid = initialize_wavefunction(grid_shape, center=[0.5, 0.5], width=width)
    psi_prev = psi_n.copy()

    for step in range(n_steps):
        psi_next, lambda_n, E_map, collapse_flag = recursive_step_dynamic(
            psi_n, psi_prev, grid, np.array(sigma), lambda_E, lambda_crit=lambda_crit, verbose=True
        )

        diff = np.linalg.norm(psi_next - psi_n)
        print(f"Step {step+1} | Œª‚Çô = {lambda_n:.6f} | ‚ÄñŒîŒ®‚Äñ = {diff:.2e} | E‚Çò‚Çê‚Çì = {np.max(E_map):.4f}")

        if collapse_flag:
            print(f"‚ùó Collapse triggered at step {step+1} (Œª‚Çô = {lambda_n:.6f})")
            return

        if diff < epsilon:
            print(f"‚úÖ Converged at step {step+1} (‚ÄñŒîŒ®‚Äñ = {diff:.2e})")
            return

        psi_prev = psi_n
        psi_n = psi_next

    print("‚ö†Ô∏è Simulation completed without collapse or convergence.")

if __name__ == "__main__":
    run_collapse_trigger_test()
